# 自顶向下的语法分析
## 自顶向下分析面临的问题
顾名思义，自上而下的主旨就是，对任何输入串，用一切可能的办法，从文法的开始符号出发，自上而下的对输入串建立一颗语法树/最左推导。这种分析过程本质上是一种试探的过程，是反复用不同产生式试图匹配输入串的过程，比如这个例子：  
假定有文法  
$$
S \to xAy  
\\
A \to **|*
$$
同时给定一个输入串α：x\*y，为了构建α的语法树（得到$$S \Rightarrow x*y$$的结果），我们按文法和输入串中的终结符进行匹配，第一步得到$$xAy \Rightarrow x*y$$；第二步替换A，由于A有两个产生式，这两个产生式都能产生输入串中的“\*”，所以分析的时候需要逐个的比较产生式。由第一个产生式得到的结果是$$ x**y \Rightarrow x*y $$，左侧第三个符号和输入串对应位置的终结符不同，此时推导宣告失败，需要回到对A的产生式再次进行分析，看是否还有别的产生式候选。  
实现这种自顶向下带回溯试探法的一个简单途径是让每个非终结符对应一个子程序，一旦发现某个候选与输入串匹配，，就用这个候选去推导语法树；否则保持原来的语法树并且尝试另外的推导。
这种自顶向下的分析法存在严重的缺陷。第一，对文法左递归的处理，如果存在形如$$P \to Pa$$的文法，这种文法将使自顶向下的分析过程陷入无限循环。第二，由于回溯的存在，使得如果推导出了错误不容易第一时间发现；中间已经做过的很多分析（包括语法和语义的）都要清空重来。第三，某个产生式匹配非终结符成功的时候，由于不能确定此后的匹配情况，所以得到的可能是虚假匹配。这种虚假匹配会造成需要更复杂的回溯技术才能保证分析的正确性。第四，一旦分析失败，难以寻找具体的出错位置。第五，这种分析方法事实上是穷举法的一个变种，所以效率低、成本高，不具备现实可行的意义。  
所以，要采用自顶向下分析，就必须先攻克左递归和回溯两大难关。  

## LL(1)分析法的产生方式
LL(1)分析法是一种自顶向下的，无回溯，无左递归的，依赖于预测分析表的一种分析方法。
左递归的消除
消除产生式中的直接左递归是比较容易的，假定产生式为：$$P \to Pa|b$$，可以把P的规则改写为以下非左递归形式：
$$
P\to bP'
\\
P’ \to aP’|ε
$$
以上两种形式是等价的。  
一般而言，假定P的全部产生式是$$P \to Pa_1|Pa_2|……|b_1|b_2|……$$，其中每个a都不等于ε，每个b都不以P作为开头，那么消除左递归的方法是把所有b写到P产生式右部的开头，并且接上一个新的非终结符P'，P'能够产生a\*P''。这种方法可以消除所有直接左递归。但是对与间接左递归，如果一个文法不存在能产生回路的推导（形如$$P \stackrel{+} \to P$$）和以ε为右部的产生式，那么可以先将带有间接左递归的一系列产生式依次代换并展开，知道得到含有直接左递归的产生式为止。此时显然可以采用上面的方法来消除左递归。  
$$
E \to T|E+T \\
T \to F|T*F \\
F \to (E)|i
$$
比如这个无二义的算术表达式文法，改写成无左递归形式应该变成这样：  
$$
E \to TE' \\
E' \to +TE'|ε \\
T \to FT’ \\
T' \to *FT'|ε \\
F \to (E)|i \\
$$

以上两种形式是等价的。  

### 消除回溯
如何准确选择候选的分支表达式，是消除回溯的根本问题所在。为了消除回溯必须保证：对文法的任意非终结符，当用来匹配输入串的时候，能够根据它面临的输入符号准确的指定它的某个产生式去进行匹配，并且这个工作结果应当是确定正确的。  
那么对于一个非终结符的任意两条候选产生式之间，都要求其右部的首终结符集相交为空，这里就涉及到非终结符的首终结符集的推导问题，首终结符集又被称为First()集。  
但是，一个文法很大概率会有一些初始文法，它们当中的非终结符并不能做到上述要求；比如对于if语句来讲。会有以下两条产生式：  
F->if 条件 then 语句 else 语句  
F->if 条件else 语句  
对于这种产生式右部又相同起始终结符的文法，我们可以通过将相同的符号提取公因式，生成一个新的非终结符来处理。这样的代价就是会多出很多非终结符和一些带有ε的产生式。  

### LL(1)分析条件
满足了无左递归和无回溯两个条件之后，也不一定能马上进行有效的自顶向下分析。因为考虑到消除回溯时的附加影响：如果一个非终结符的First()集当中包含了ε，那么仍然要进行处理。  
考虑到以前讲的那个无二义、无左递归的算术表达式文法：  
$$
E \to TE' \\
E' \to +TE'|ε \\
T \to FT’ \\
T' \to *FT'|ε \\
F \to (E)|i \\
$$
如果对算术表达式i\*i进行分析，会产生什么结果？
①、分析程序读入i，非终结符被替换为TE'；  
②、分析程序将非终结符T替换为FT'；  
③、分析程序将F替换成i；  
④、分析程序匹配到i，指针移向下一位，读入\*；  
此时符号栈当中的符号由左到右依次是i T’E’，可以看到，对于E'来说，它的First()集当中并没有\*，只能将E'替换为ε。但是这种替换一定是对的么？如果T'无法推导出\*的话，这就意味着事实上发生了回溯。因此这里需要引入新的集合定义：尾随附终结符集（Follow()集），Follow()集是指跟随于非终结符之后的可能的第一个终结符所组成的集合，一般就是一些零散的终结符加上文法中可能跟随的非终结符的First()集。所以如果非终结符的First()集中没有当前终结符但是有ε，且它的Follow()集中有当前终结符，才能允许使用这个非终结符进行匹配。  

经过上面三节的分析，可以得出满足能够进行不带回溯的自顶向下分析的文法充要条件是：  
1. 文法不含左递归  

2. 文法中任意非终结符的所有产生式的First()集两两相交为空集  

3. 文法中任意非终结符，如果它的First()集中有ε，那么它的First()集交Follow()集的结果是空集。  

满足以上三个条件的，称为LL(1)文法。  
